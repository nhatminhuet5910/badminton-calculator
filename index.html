<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLB ƒê·ªët Ti·ªÅn C·∫ßu</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- CSS CH√çNH --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; color: #333; padding: 15px; box-sizing: border-box;
        }
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(20, 0, 50, 0.8), rgba(0, 0, 0, 0.6)); z-index: 0;
        }
        .container {
            position: relative; z-index: 1; background: rgba(255, 255, 255, 0.96);
            padding: 20px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            width: 100%; max-width: 450px; backdrop-filter: blur(5px); border: 2px solid rgba(255, 255, 255, 0.4);
        }
        h2 { margin-top: 0; font-weight: 800; color: #d63031; font-size: 1.5rem; text-transform: uppercase; text-align: center; }
        .subtitle { text-align: center; font-size: 0.8rem; color: #636e72; margin-bottom: 15px; font-style: italic; }
        
        .section-title { font-size: 0.75rem; color: #b2bec3; background: #2d3436; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 10px; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-group { flex: 1; }
        label { display: block; margin-bottom: 4px; font-size: 0.85rem; font-weight: 600; color: #2d3436; }
        input, select { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 16px; background: #fdfdfd; font-weight: 500; appearance: none; box-sizing: border-box; }
        input:focus { outline: none; border-color: #00cec9; background: #fff; }
        #tienCau { border-color: #ff7675; color: #d63031; font-weight: 700; }
        
        /* N√∫t b·∫•m */
        .button-area { display: flex; gap: 10px; margin-top: 20px; }
        button { padding: 12px; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; transition: 0.2s; text-transform: uppercase; flex: 1; color: white; }
        .btn-calc { background: linear-gradient(135deg, #0984e3, #6c5ce7); }
        .btn-camera { background: linear-gradient(135deg, #00b894, #00cec9); display: none; }
        button:active { transform: translateY(2px); }

        /* K·∫øt qu·∫£ */
        .result { margin-top: 15px; padding: 15px; background: #fff; border-radius: 12px; border: 2px dashed #6c5ce7; display: none; }
        .result-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; font-weight: 600; }
        .divider { height: 1px; background: #dfe6e9; margin: 10px 0; }
        
        /* Tab & Upload */
        .bank-config { background: #f0fdf4; padding: 10px; border-radius: 10px; border: 1px solid #bbf7d0; margin-bottom: 10px; }
        
        /* Toggle Switch ƒê·∫πp */
        .switch-toggle { display: flex; background: #e0e7ff; border-radius: 20px; padding: 3px; margin: 10px 0; }
        .switch-btn { flex: 1; text-align: center; padding: 8px; border-radius: 17px; cursor: pointer; font-size: 0.8rem; font-weight: 700; color: #636e72; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .switch-btn.active { background: white; color: #16a34a; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .file-upload-wrapper { border: 2px dashed #b2bec3; border-radius: 10px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; color: #636e72; background: white; }
        .file-upload-wrapper input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .upload-success-text { color: #16a34a; font-weight: bold; display: none; margin-top: 5px; font-size: 0.8rem; }

        /* --- PH·∫¶N H√ìA ƒê∆†N ƒê·ªÇ CH·ª§P (·∫®n kh·ªèi m√†n h√¨nh) --- */
        #invoice-node {
            position: absolute; top: -9999px; left: -9999px;
            width: 400px; background: #fff; padding: 20px;
            font-family: 'Courier New', Courier, monospace; 
            color: #000; border: 1px solid #000;
        }
        .inv-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .inv-title { font-size: 1.5rem; font-weight: bold; }
        .inv-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1rem; }
        .inv-total { border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 1.2rem; }
        
        /* QR trong h√≥a ƒë∆°n */
        .inv-qr { display: flex; justify-content: space-between; margin-top: 15px; }
        .inv-qr-box { text-align: center; width: 48%; }
        /* Fix l·ªói ·∫£nh QR b·ªã ·∫©n */
        .inv-qr-box img { width: 100%; border: 1px solid #333; display: block; margin-top: 5px; } 
        .inv-footer { text-align: center; margin-top: 15px; font-size: 0.8rem; font-style: italic; }

        /* Modal hi·ªÉn th·ªã ·∫£nh */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { text-align: center; width: 90%; max-width: 400px; }
        .modal-content img { width: 100%; border-radius: 5px; box-shadow: 0 0 15px rgba(255,255,255,0.3); border: 3px solid white; }
        .modal-btn-close { margin-top: 15px; padding: 10px 30px; background: #d63031; color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

<div class="overlay"></div>

<div class="modal-overlay" id="photoModal">
    <div style="color: white; font-size: 1.2rem; margin-bottom: 10px;" id="loadingText">‚è≥ ƒêang in h√≥a ƒë∆°n...</div>
    <div class="modal-content" id="modalContent" style="display: none;">
        <div style="color: #fab1a0; margin-bottom: 5px; font-size: 0.9rem;">üëá Nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ L∆ØU nh√©!</div>
        <img id="capturedImage" src="">
        <button class="modal-btn-close" onclick="closeModal()">ƒê√≥ng l·∫°i</button>
    </div>
</div>

<div class="container">
    <h2>üí∏ CLB ƒê·ªêT TI·ªÄN C·∫¶U</h2>
    <div class="subtitle">S√¢n kinh t·∫ø, t√≠nh ti·ªÅn ƒë·ª´ng th·∫Øc m·∫Øc</div>

    <div class="bank-config">
        <div class="section-title" style="margin-top:0; color: #166534; background: none; padding: 0;">
            <i class="fas fa-university"></i> KHO TH√ìC NH·∫¨N TI·ªÄN
        </div>

        <div class="switch-toggle">
            <div class="switch-btn active" id="tabAuto" onclick="switchTab('auto')"><i class="fas fa-magic"></i> Auto T·∫≠n RƒÉng</div>
            <div class="switch-btn" id="tabManual" onclick="switchTab('manual')"><i class="fas fa-image"></i> ·∫¢nh QR (H√†ng Th·ª≠a)</div>
        </div>

        <div id="modeAuto">
            <div class="input-row">
                <div class="input-group">
                    <label>Kho B·∫°c (Ng√¢n h√†ng)</label>
                    <select id="bankId" onchange="saveBankInfo()">
                        <option value="">Ch·ªçn Kho...</option>
                        <option value="970436">Vietcombank</option>
                        <option value="970415">VietinBank</option>
                        <option value="970422">MB Bank</option>
                        <option value="970407">Techcombank</option>
                        <option value="970418">BIDV</option>
                        <option value="970405">Agribank</option>
                        <option value="970423">TPBank</option>
                        <option value="970432">VPBank</option>
                        <option value="970416">ACB</option>
                        <option value="970403">Sacombank</option>
                        <option value="970441">VIB</option>
                        <option value="963388">Timo</option>
                        <option value="971011">Momo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>M·∫≠t m√£ k√©t (STK)</label>
                    <input type="text" id="accountNo" placeholder="Nh·∫≠p STK..." oninput="saveBankInfo()">
                </div>
            </div>
            <div class="input-group">
                <label>Ch·ªß N·ª£ (T√™n kh√¥ng d·∫•u)</label>
                <input type="text" id="accountName" placeholder="V√≠ d·ª•: NGUYEN VAN A" oninput="saveBankInfo()">
            </div>
            <div style="font-size: 0.7rem; color: #166534; margin-top: 5px; font-style: italic;">
                <i class="fas fa-check-circle"></i> T·ª± ƒë·ªông l∆∞u, l·∫ßn sau kh√¥ng c·∫ßn nh·∫≠p l·∫°i.
            </div>
        </div>

        <div id="modeManual" style="display: none;">
            <div class="file-upload-wrapper">
                <input type="file" id="qrUpload" accept="image/*" onchange="previewUploadedQR(event)">
                <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem;"></i>
                <span id="uploadText">B·∫•m ch·ªçn ·∫£nh QR t·ª´ m√°y</span>
                <span class="upload-success-text" id="uploadSuccess"><i class="fas fa-check"></i> ƒê√£ nh·∫≠n h√†ng!</span>
            </div>
            <div style="font-size: 0.7rem; color: #d63031; margin-top: 8px; font-style: italic;">
                *D√πng ·∫£nh n√†y th√¨ anh em t·ª± nh·∫≠p s·ªë ti·ªÅn nh√©.
            </div>
        </div>
    </div>

    <div class="section-title">üíÄ Chi Ph√≠ M·∫∑t B·∫±ng (Chia ƒê·ªÅu)</div>
    <div class="input-row">
        <div class="input-group"><label>C·ªëng n·∫°p ch·ªß s√¢n</label><input type="number" id="tienSan" placeholder="200000"></div>
        <div class="input-group"><label>N∆∞·ªõc th√°nh</label><input type="number" id="tienNuoc" placeholder="30000"></div>
    </div>
    <div class="input-group" style="margin-bottom: 10px;">
        <label>ƒÇn ch∆°i nh·∫£y m√∫a kh√°c</label><input type="number" id="chiPhiKhac" placeholder="G·ª≠i xe, tr√† ƒë√°...">
    </div>
    
    <div class="section-title" style="background: #d63031; color: white;">üî• Thi·ªát H·∫°i L√¥ng L√°</div>
    <div class="input-group" style="margin-bottom: 10px;">
        <label>Ti·ªÅn C·∫ßu (Nam ph√°, N·ªØ ch·ªãu)</label>
        <input type="number" id="tienCau" placeholder="Nh·∫≠p s·ªë ti·ªÅn c·∫ßu..." >
        <div style="font-size: 0.7rem; color: #636e72; font-style: italic; margin-top: 5px;">*Logic: Nam ƒë√≥ng g·∫•p ƒë√¥i N·ªØ (Cho ch·ª´a c√°i t·ªôi ƒë·∫≠p c·∫ßu).</div>
    </div>

    <div class="section-title">üëΩ ƒêi·ªÉm Danh</div>
    <div class="input-row">
        <div class="input-group"><label>Nam th·∫ßn (‚ôÇ)</label><input type="number" id="soNam" placeholder="0"></div>
        <div class="input-group"><label>N·ªØ th·∫ßn (‚ôÄ)</label><input type="number" id="soNu" placeholder="0"></div>
    </div>

    <div class="button-area">
        <button class="btn-calc" onclick="tinhTien()">‚ö° B·∫•m Xem Ai Ngh√®o H∆°n</button>
        <button class="btn-camera" id="btnCamera" onclick="chupHoaDon()">üì∏ S·ªë Ti·ªÅn ƒê√≥ng H·ªç</button>
    </div>

    <div class="result" id="khuVucKetQua">
        <div class="result-item"><span>T·ªïng thi·ªát h·∫°i:</span><span id="hienThiTong" style="color:#d63031">0 ƒë</span></div>
        <div class="divider"></div>
        <div class="result-item" style="color:#0984e3"><span>üë¶ Anh em m√≥c v√≠:</span><span id="giaNam">0 ƒë</span></div>
        <div class="result-item" style="color:#e84393"><span>üëß Ch·ªã em ƒë√≥ng nh·∫π:</span><span id="giaNu">0 ƒë</span></div>
        
        <div id="screenQrArea" style="text-align: center; margin-top: 15px; display: none;">
            <div style="font-weight: bold; font-size: 0.8rem; margin-bottom: 5px; color: #166534;">üì≤ QU√âT NHANH KH√îNG L√ÉI M·∫∏ ƒê·∫∫ L√ÉI CON</div>
            <div style="display: flex; gap: 5px; justify-content: center;">
                <img id="screenQrNam" style="width: 45%; border: 1px solid #ccc; border-radius: 5px;">
                <img id="screenQrNu" style="width: 45%; border: 1px solid #ccc; border-radius: 5px;">
            </div>
        </div>
        
        <div class="note">*S·ªë li·ªáu chu·∫©n t·ª´ng xu (kh√¥ng l√†m tr√≤n)</div>
    </div>
</div>

<div id="invoice-node">
    <div class="inv-header">
        <div class="inv-title">CLB ƒê·ªêT TI·ªÄN C·∫¶U</div>
        <div>--- H√ìA ƒê∆†N THANH TO√ÅN ---</div>
        <div id="invDate" style="font-size: 0.8rem;"></div>
    </div>
    
    <div class="inv-row"><span>Ti·ªÅn s√¢n + N∆∞·ªõc:</span><span id="invCommon">0</span></div>
    <div class="inv-row"><span>Ti·ªÅn c·∫ßu:</span><span id="invCau">0</span></div>
    <div class="inv-row"><span>Qu√¢n s·ªë:</span><span id="invMember">0 Nam / 0 N·ªØ</span></div>
    
    <div class="inv-total">
        <div class="inv-row"><span>T·ªîNG BILL:</span><span id="invTotal">0</span></div>
    </div>

    <div style="margin-top: 10px; border-top: 1px solid #000; padding-top: 5px;">
        <div class="inv-row" style="font-weight: bold;">
            <span>üë¶ NAM:</span><span id="invPriceNam">0</span>
        </div>
        <div class="inv-row" style="font-weight: bold;">
            <span>üëß N·ªÆ:</span><span id="invPriceNu">0</span>
        </div>
    </div>

    <div class="inv-qr" id="invQrArea">
        <div class="inv-qr-box">
            <div style="font-size: 0.7rem; font-weight: bold;">NAM QU√âT ƒê√ÇY</div>
            <img id="invQrNam" src="" crossorigin="anonymous"> 
        </div>
        <div class="inv-qr-box">
            <div style="font-size: 0.7rem; font-weight: bold;">N·ªÆ QU√âT ƒê√ÇY</div>
            <img id="invQrNu" src="" crossorigin="anonymous" style="display: block;">
        </div>
    </div>

    <div class="inv-footer">
        "Vui l√≤ng thanh to√°n ƒë·ªß.<br>Thi·∫øu 1 xu, ngh·ªâ ƒë√°nh tu·∫ßn sau!"
    </div>
</div>

<script>
    // Load th√¥ng tin c≈©
    window.onload = function() {
        if(localStorage.getItem('bankId')) document.getElementById('bankId').value = localStorage.getItem('bankId');
        if(localStorage.getItem('accountNo')) document.getElementById('accountNo').value = localStorage.getItem('accountNo');
        if(localStorage.getItem('accountName')) document.getElementById('accountName').value = localStorage.getItem('accountName');
    }

    let currentMode = 'auto';
    let uploadedQRData = '';

    function switchTab(mode) {
        currentMode = mode;
        document.getElementById('modeAuto').style.display = mode === 'auto' ? 'block' : 'none';
        document.getElementById('modeManual').style.display = mode === 'manual' ? 'block' : 'none';
        document.getElementById('tabAuto').className = mode === 'auto' ? 'switch-btn active' : 'switch-btn';
        document.getElementById('tabManual').className = mode === 'manual' ? 'switch-btn active' : 'switch-btn';
    }

    function saveBankInfo() {
        localStorage.setItem('bankId', document.getElementById('bankId').value);
        localStorage.setItem('accountNo', document.getElementById('accountNo').value);
        localStorage.setItem('accountName', document.getElementById('accountName').value);
    }

    function previewUploadedQR(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedQRData = e.target.result;
                document.getElementById('uploadText').innerText = "ƒê√£ ch·ªçn: " + file.name;
                document.getElementById('uploadText').style.display = 'none';
                document.getElementById('uploadSuccess').style.display = 'inline';
            }
            reader.readAsDataURL(file);
        }
    }

    function formatMoney(amount) {
        return amount.toLocaleString('vi-VN') + ' ƒë';
    }

    function tinhTien() {
        let san = Number(document.getElementById('tienSan').value) || 0;
        let nuoc = Number(document.getElementById('tienNuoc').value) || 0;
        let khac = Number(document.getElementById('chiPhiKhac').value) || 0;
        let cau = Number(document.getElementById('tienCau').value) || 0;
        let nam = Number(document.getElementById('soNam').value) || 0;
        let nu = Number(document.getElementById('soNu').value) || 0;
        let tongNguoi = nam + nu;

        if (tongNguoi === 0) { alert("Alo? Kh√¥ng ai ƒëi ƒë√°nh √†?"); return; }

        let phiChung = (san + nuoc + khac) / tongNguoi;
        let tienCauNam = 0, tienCauNu = 0;

        // Logic h·ªá s·ªë: N·ªØ ch·ªãu 1, Nam ch·ªãu 2 (T∆∞∆°ng ƒë∆∞∆°ng Nam ƒë√≥ng g·∫•p ƒë√¥i)
        if (cau > 0) {
            let tongSuat = (nam * 2) + (nu * 1);
            if (tongSuat > 0) {
                let gia1Suat = cau / tongSuat;
                tienCauNu = gia1Suat;
                tienCauNam = gia1Suat * 2;
            }
        }

        let giaNam = Math.ceil(phiChung + tienCauNam);
        let giaNu = Math.ceil(phiChung + tienCauNu);
        let tongTien = san + nuoc + khac + cau;

        // HI·ªÇN TH·ªä
        document.getElementById('hienThiTong').innerText = formatMoney(tongTien);
        document.getElementById('giaNam').innerText = formatMoney(giaNam);
        document.getElementById('giaNu').innerText = formatMoney(giaNu);

        // --- X·ª¨ L√ù QR H√ìA ƒê∆†N ---
        // 1. ƒêi·ªÅn th√¥ng tin v√†o h√≥a ƒë∆°n
        let today = new Date();
        document.getElementById('invDate').innerText = today.toLocaleDateString('vi-VN') + " " + today.toLocaleTimeString('vi-VN');
        document.getElementById('invCommon').innerText = formatMoney(san + nuoc + khac);
        document.getElementById('invCau').innerText = formatMoney(cau);
        document.getElementById('invMember').innerText = `${nam} Nam / ${nu} N·ªØ`;
        document.getElementById('invTotal').innerText = formatMoney(tongTien);
        document.getElementById('invPriceNam').innerText = formatMoney(giaNam);
        document.getElementById('invPriceNu').innerText = formatMoney(giaNu);

        // 2. X·ª≠ l√Ω QR
        let bankId = document.getElementById('bankId').value;
        let accountNo = document.getElementById('accountNo').value;
        let accountName = document.getElementById('accountName').value;
        
        let screenQrArea = document.getElementById('screenQrArea');
        let invQrArea = document.getElementById('invQrArea');
        
        // Reset QR src
        document.getElementById('screenQrNam').src = "";
        document.getElementById('screenQrNu').src = "";
        document.getElementById('invQrNam').src = "";
        document.getElementById('invQrNu').src = "";

        if (currentMode === 'auto' && bankId && accountNo) {
            let baseUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact2.jpg`;
            let contentNam = encodeURIComponent("NAM DONG TIEN CAU");
            let contentNu = encodeURIComponent("NU DONG TIEN CAU");
            
            let urlNam = `${baseUrl}?amount=${giaNam}&addInfo=${contentNam}&accountName=${encodeURIComponent(accountName)}`;
            let urlNu = `${baseUrl}?amount=${giaNu}&addInfo=${contentNu}&accountName=${encodeURIComponent(accountName)}`;
            
            // Set cho m√†n h√¨nh ch√≠nh
            document.getElementById('screenQrNam').src = urlNam;
            document.getElementById('screenQrNu').src = urlNu;
            screenQrArea.style.display = 'block';

            // Set cho h√≥a ƒë∆°n ·∫©n
            document.getElementById('invQrNam').src = urlNam;
            document.getElementById('invQrNu').src = urlNu;
            
            // Hi·ªán c·∫£ 2 QR trong h√≥a ƒë∆°n
            document.getElementById('invQrNam').style.display = 'block';
            document.getElementById('invQrNu').style.display = 'block';
            invQrArea.style.display = 'flex';

        } else if (currentMode === 'manual' && uploadedQRData) {
            // Ch·∫ø ƒë·ªô ·∫£nh tay: Ch·ªâ hi·ªán 1 QR
            document.getElementById('screenQrNam').src = uploadedQRData;
            document.getElementById('screenQrNu').style.display = 'none'; // ·∫®n b·ªõt 1 c√°i
            screenQrArea.style.display = 'block';

            // H√≥a ƒë∆°n
            document.getElementById('invQrNam').src = uploadedQRData;
            document.getElementById('invQrNu').style.display = 'none'; // ·∫®n b·ªõt
            invQrArea.style.display = 'flex';
        } else {
            screenQrArea.style.display = 'none';
            invQrArea.style.display = 'none';
        }

        document.getElementById('khuVucKetQua').style.display = 'block';
        document.getElementById('btnCamera').style.display = 'block';
        document.getElementById('khuVucKetQua').scrollIntoView({ behavior: 'smooth' });
    }

    // --- CH·ª§P H√ìA ƒê∆†N ---
    function chupHoaDon() {
        let modal = document.getElementById('photoModal');
        let loading = document.getElementById('loadingText');
        let img = document.getElementById('capturedImage');
        let content = document.getElementById('modalContent');
        
        modal.style.display = 'flex';
        loading.style.display = 'block';
        content.style.display = 'none';

        let invoiceNode = document.getElementById('invoice-node');

        setTimeout(() => {
            html2canvas(invoiceNode, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff' 
            }).then(canvas => {
                img.src = canvas.toDataURL("image/png");
                loading.style.display = 'none';
                content.style.display = 'block';
            }).catch(err => {
                alert("L·ªói ch·ª•p: " + err);
                closeModal();
            });
        }, 500); 
    }

    function closeModal() { document.getElementById('photoModal').style.display = 'none'; }
</script>

</body>
</html>