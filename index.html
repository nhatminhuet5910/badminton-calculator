<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLB ƒê·ªët Ti·ªÅn C·∫ßu - Phi√™n B·∫£n T·∫øt</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Pangolin&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS THEME T·∫æT --- */
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            /* ·∫¢nh n·ªÅn T·∫øt */
            background: url('background2.jpg') no-repeat center center fixed; 
            background-size: cover;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; color: #333; padding: 15px; box-sizing: border-box;
            font-weight: 400;
        }
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: 0; pointer-events: none;
        }
        
        /* KHUNG CH√çNH (M√ÄU KEM & VI·ªÄN ƒê·ªé) */
        .container {
            position: relative; z-index: 1; 
            background: rgba(255, 255, 240, 0.96); /* M√†u kem s√°ng */
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(214, 48, 49, 0.4); 
            width: 100%; max-width: 450px; 
            border: 2px solid #e17055; 
        }
        
        /* Ti√™u ƒë·ªÅ - Font vui nh·ªôn */
        h2 { 
            font-family: 'Pangolin', cursive;
            margin-top: 0; font-weight: 800; 
            color: #d63031; /* ƒê·ªè ƒë·∫≠m */
            font-size: 1.8rem; text-transform: uppercase; text-align: center;
            text-shadow: 1px 1px 0px #f1c40f; 
            margin-bottom: 5px;
        }
        .subtitle { 
            text-align: center; font-size: 0.9rem; color: #c0392b; 
            margin-bottom: 20px; font-style: italic; font-weight: 400; 
        }
        
        /* Section Title (ƒê·ªè vi·ªÅn V√†ng) */
        .section-title { 
            font-size: 0.8rem; color: #fff; 
            background: #d63031; 
            padding: 6px 12px; border-radius: 15px; 
            display: inline-block; margin-top: 10px; margin-bottom: 8px; 
            font-weight: 700; text-transform: uppercase;
            border: 1px solid #f1c40f; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Inputs */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-group { flex: 1; }
        label { display: block; margin-bottom: 5px; font-size: 0.85rem; font-weight: 600; color: #c0392b; }
        input, select { 
            width: 100%; padding: 10px; 
            border: 1px solid #fab1a0; 
            border-radius: 8px; font-size: 16px; 
            background: #fff; font-weight: 500; 
            color: #2d3436;
            appearance: none; box-sizing: border-box; 
        }
        input:focus { outline: none; border-color: #d63031; box-shadow: 0 0 5px rgba(214, 48, 49, 0.2); }
        #tienCau { border-color: #d63031; color: #d63031; font-weight: 700; background: #fff5f5; }
        
        /* Buttons */
        .button-area { display: flex; gap: 10px; margin-top: 25px; }
        button { 
            padding: 12px; border: none; border-radius: 10px; 
            font-size: 15px; font-weight: 700; cursor: pointer; 
            transition: 0.2s; text-transform: uppercase; flex: 1; color: #fff;
            border: 1px solid #f1c40f; 
        }
        .btn-calc { background: linear-gradient(135deg, #e17055, #d63031); box-shadow: 0 3px 0 #b33939; }
        .btn-calc:active { transform: translateY(3px); box-shadow: none; }
        .btn-camera { background: linear-gradient(135deg, #00b894, #00cec9); box-shadow: 0 3px 0 #008c7a; display: none; }
        .btn-camera:active { transform: translateY(3px); box-shadow: none; }

        /* K·∫øt qu·∫£ */
        .result { margin-top: 20px; padding: 15px; background: #fff; border-radius: 12px; border: 2px dashed #d63031; display: none; }
        .result-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; font-weight: 400; color: #2d3436; }
        .result-item span:last-child { font-weight: 700; }
        .divider { height: 1px; background: #fab1a0; margin: 12px 0; }
        
        /* Config Box */
        .bank-config { background: #fff0f0; padding: 15px; border-radius: 12px; border: 1px solid #ff7675; margin-bottom: 15px; }
        .switch-toggle { display: flex; background: #fab1a0; border-radius: 20px; padding: 3px; margin: 10px 0; }
        .switch-btn { flex: 1; text-align: center; padding: 8px; border-radius: 17px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: #fff; transition: 0.3s; }
        .switch-btn.active { background: #d63031; color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .file-upload-wrapper { border: 2px dashed #d63031; border-radius: 10px; height: 80px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; color: #d63031; background: white; cursor: pointer;}
        .file-upload-wrapper input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .upload-success-text { color: #27ae60; font-weight: 700; display: none; margin-top: 5px; font-size: 0.8rem; }

        /* --- H√ìA ƒê∆†N ·∫®N (FIX L·ªÜCH) --- */
        #hidden-invoice-wrapper {
            position: fixed; top: 0; left: 0; width: 450px; z-index: -9999; opacity: 0; pointer-events: none;
        }

        #invoice-node {
            width: 100%; background: #fff; padding: 25px;
            font-family: 'Courier New', Courier, monospace; 
            color: #000; border: 5px double #d63031;
            position: relative; box-sizing: border-box;
        }

        .inv-header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; }
        .inv-title { font-size: 1.5rem; font-weight: 700; color: #d63031; font-family: 'Roboto', sans-serif; text-transform: uppercase; }
        .inv-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 1rem; font-weight: 400; }
        .inv-row span:last-child { font-weight: 600; }
        .inv-total { border-top: 2px dashed #000; margin-top: 10px; padding-top: 10px; font-weight: 700; font-size: 1.2rem; color: #d63031; }
        
        .inv-qr { display: flex; justify-content: space-between; margin-top: 20px; gap: 20px; }
        .inv-qr-box { text-align: center; width: 48%; }
        .inv-qr-box img.qr-nam-style { width: 100%; display: block; margin-top: 5px; border: 4px solid #0984e3; border-radius: 8px; padding: 2px; }
        .inv-qr-box img.qr-nu-style { width: 100%; display: block; margin-top: 5px; border: 4px solid #e84393; border-radius: 8px; padding: 2px; }
        .inv-footer { text-align: center; margin-top: 20px; font-size: 0.85rem; font-style: italic; position: relative; z-index: 5; font-weight: 400; }

        /* Con d·∫•u */
        .stamp-box {
            position: absolute; bottom: 70px; right: 30px;
            width: 90px; height: 90px; border-radius: 50%;
            border: 3px solid #d63031;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #d63031; font-weight: 700; font-size: 0.8rem;
            text-transform: uppercase; text-align: center;
            transform: rotate(-20deg); opacity: 0.8; z-index: 10;
            pointer-events: none; background: rgba(255, 255, 255, 0.7); 
            font-family: 'Roboto', sans-serif; line-height: 1.2;
        }
        .stamp-inner { border-top: 1px solid #d63031; border-bottom: 1px solid #d63031; padding: 2px 0; margin-top: 3px; font-size: 0.7rem; font-weight: 900; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { text-align: center; width: 95%; max-width: 450px; }
        .modal-content img { width: 100%; border-radius: 5px; box-shadow: 0 0 20px rgba(255,255,255,0.2); border: 3px solid white; }
        .modal-btn-close { margin-top: 20px; padding: 10px 30px; background: #d63031; color: white; border: none; border-radius: 20px; font-weight: 600; cursor: pointer; font-size: 16px; border: 2px solid #fff; }
    </style>
</head>
<body>

<div class="overlay"></div>

<div class="modal-overlay" id="photoModal">
    <div style="color: white; font-size: 1.2rem; margin-bottom: 10px; font-weight: 500;" id="loadingText">üßß ƒêang xu·∫•t h√≥a ƒë∆°n...</div>
    <div class="modal-content" id="modalContent" style="display: none;">
        <div style="color: #fab1a0; margin-bottom: 5px; font-size: 0.9rem;">üëá Nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ L∆ØU nh√©!</div>
        <img id="capturedImage" src="">
        <button class="modal-btn-close" onclick="closeModal()">ƒê√≥ng l·∫°i</button>
    </div>
</div>

<div class="container">
    <h2>üßß CLB ƒê·ªêT TI·ªÄN C·∫¶U üßß</h2>
    <div class="subtitle">S√¢n kinh t·∫ø, t√≠nh ti·ªÅn ƒë·ª´ng th·∫Øc m·∫Øc</div>

    <div class="bank-config">
        <div class="section-title"><i class="fas fa-university"></i> KHO TH√ìC NH·∫¨N TI·ªÄN</div>

        <div class="switch-toggle">
            <div class="switch-btn active" id="tabAuto" onclick="switchTab('auto')"><i class="fas fa-magic"></i> Auto T·∫≠n RƒÉng</div>
            <div class="switch-btn" id="tabManual" onclick="switchTab('manual')"><i class="fas fa-image"></i> ·∫¢nh QR (H√†ng Th·ª≠a)</div>
        </div>

        <div id="modeAuto">
            <div class="input-row">
                <div class="input-group">
                    <label>Kho B·∫°c (Ng√¢n h√†ng)</label>
                    <select id="bankId" onchange="saveBankInfo()">
                        <option value="">Ch·ªçn Kho...</option>
                        <option value="970436">Vietcombank</option>
                        <option value="970415">VietinBank</option>
                        <option value="970422">MB Bank</option>
                        <option value="970407">Techcombank</option>
                        <option value="970418">BIDV</option>
                        <option value="970405">Agribank</option>
                        <option value="970423">TPBank</option>
                        <option value="970432">VPBank</option>
                        <option value="970416">ACB</option>
                        <option value="970403">Sacombank</option>
                        <option value="970441">VIB</option>
                        <option value="970454">VietCapital</option>
                        <option value="963388">Timo</option>
                        <option value="971005">ViettelMoney</option>
                        <option value="971011">Momo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>M·∫≠t m√£ k√©t (STK)</label>
                    <input type="text" id="accountNo" placeholder="Nh·∫≠p STK..." oninput="saveBankInfo()">
                </div>
            </div>
            <div class="input-group">
                <label>Ch·ªß N·ª£ (T√™n kh√¥ng d·∫•u)</label>
                <input type="text" id="accountName" placeholder="V√≠ d·ª•: NGUYEN VAN A" oninput="saveBankInfo()">
            </div>
            <div style="font-size: 0.75rem; color: #c0392b; margin-top: 5px; font-style: italic;">
                <i class="fas fa-check-circle"></i> T·ª± ƒë·ªông l∆∞u, l·∫ßn sau kh√¥ng c·∫ßn nh·∫≠p l·∫°i.
            </div>
        </div>

        <div id="modeManual" style="display: none;">
            <div class="file-upload-wrapper">
                <input type="file" id="qrUpload" accept="image/*" onchange="previewUploadedQR(event)">
                <i class="fas fa-cloud-upload-alt" style="font-size: 1.5rem;"></i>
                <span id="uploadText">B·∫•m ch·ªçn ·∫£nh QR t·ª´ m√°y</span>
                <span class="upload-success-text" id="uploadSuccess"><i class="fas fa-check"></i> ƒê√£ nh·∫≠n h√†ng!</span>
            </div>
            <div style="font-size: 0.75rem; color: #d63031; margin-top: 8px; font-style: italic;">
                *D√πng ·∫£nh n√†y th√¨ anh em t·ª± nh·∫≠p s·ªë ti·ªÅn nh√©.
            </div>
        </div>
    </div>

    <div class="section-title">üèÆ Chi Ph√≠ M·∫∑t B·∫±ng</div>
    <div class="input-row">
        <div class="input-group"><label>C·ªëng n·∫°p ch·ªß s√¢n</label><input type="number" id="tienSan" placeholder="200000"></div>
        <div class="input-group"><label>N∆∞·ªõc th√°nh</label><input type="number" id="tienNuoc" placeholder="30000"></div>
    </div>
    <div class="input-group" style="margin-bottom: 10px;">
        <label>ƒÇn ch∆°i nh·∫£y m√∫a kh√°c</label><input type="number" id="chiPhiKhac" placeholder="G·ª≠i xe, tr√† ƒë√°...">
    </div>
    
    <div class="section-title" style="background: #e17055;">üî• Thi·ªát H·∫°i L√¥ng L√°</div>
    <div class="input-group" style="margin-bottom: 10px;">
        <label>Ti·ªÅn C·∫ßu (Nam ph√°, N·ªØ ch·ªãu)</label>
        <input type="number" id="tienCau" placeholder="Nh·∫≠p s·ªë ti·ªÅn c·∫ßu..." >
        <div style="font-size: 0.75rem; color: #c0392b; font-style: italic; margin-top: 5px;">*Logic: Nam ƒë√≥ng g·∫•p ƒë√¥i N·ªØ.</div>
    </div>

    <div class="section-title" style="background: #27ae60;">üëΩ ƒêi·ªÉm Danh</div>
    <div class="input-row">
        <div class="input-group"><label>Nam th·∫ßn (‚ôÇ)</label><input type="number" id="soNam" placeholder="0"></div>
        <div class="input-group"><label>N·ªØ th·∫ßn (‚ôÄ)</label><input type="number" id="soNu" placeholder="0"></div>
    </div>

    <div class="button-area">
        <button class="btn-calc" onclick="tinhTien()">‚ö° B·∫•m Xem Ai Ngh√®o H∆°n</button>
        <button class="btn-camera" id="btnCamera" onclick="chupHoaDon()">üì∏ Xu·∫•t Ho√° ƒê∆°n</button>
    </div>

    <div class="result" id="khuVucKetQua">
        <div class="result-item"><span>T·ªïng thi·ªát h·∫°i:</span><span id="hienThiTong" style="color:#d63031; font-size: 1.2rem;">0 ƒë</span></div>
        <div class="divider"></div>
        <div class="result-item" style="color:#0984e3"><span>üë¶ Anh em m√≥c v√≠:</span><span id="giaNam">0 ƒë</span></div>
        <div class="result-item" style="color:#e84393"><span>üëß Ch·ªã em ƒë√≥ng nh·∫π:</span><span id="giaNu">0 ƒë</span></div>
        
        <div id="screenQrArea" style="text-align: center; margin-top: 15px; display: none;">
            <div style="font-weight: 700; font-size: 0.8rem; margin-bottom: 5px; color: #c0392b;">üì≤ QU√âT NHANH KH√îNG L√ÉI M·∫∏ ƒê·∫∫ L√ÉI CON</div>
            <div style="display: flex; gap: 30px; justify-content: center;">
                <div id="boxScreenQrNam" style="width: 45%;">
                    <img id="screenQrNam" style="width: 100%; border: 4px solid #0984e3; border-radius: 8px;">
                </div>
                <div id="boxScreenQrNu" style="width: 45%;">
                    <img id="screenQrNu" style="width: 100%; border: 4px solid #e84393; border-radius: 8px;">
                </div>
            </div>
        </div>
        
        <div class="note">*S·ªë li·ªáu chu·∫©n t·ª´ng xu (kh√¥ng l√†m tr√≤n)</div>
    </div>
</div>

<div id="hidden-invoice-wrapper">
    <div id="invoice-node">
        <div class="stamp-box">
            CLB C·∫¶U L√îNG
            <div class="stamp-inner">ƒê√É THU TI·ªÄN</div>
        </div>

        <div class="inv-header">
            <div class="inv-title">CLB ƒê·ªêT TI·ªÄN C·∫¶U</div>
            <div>--- H√ìA ƒê∆†N T·∫æT ---</div>
            <div id="invDate" style="font-size: 0.9rem;"></div>
        </div>
        
        <div class="inv-row"><span>Ti·ªÅn s√¢n + N∆∞·ªõc:</span><span id="invCommon">0</span></div>
        <div class="inv-row"><span>Ti·ªÅn c·∫ßu:</span><span id="invCau">0</span></div>
        <div class="inv-row"><span>Qu√¢n s·ªë:</span><span id="invMember">0 Nam / 0 N·ªØ</span></div>
        
        <div class="inv-total">
            <div class="inv-row"><span>T·ªîNG BILL:</span><span id="invTotal">0</span></div>
        </div>

        <div style="margin-top: 10px; border-top: 1px solid #000; padding-top: 5px;">
            <div class="inv-row" style="font-weight: 700;">
                <span>üë¶ NAM:</span><span id="invPriceNam">0</span>
            </div>
            <div class="inv-row" style="font-weight: 700;">
                <span>üëß N·ªÆ:</span><span id="invPriceNu">0</span>
            </div>
        </div>

        <div class="inv-qr" id="invQrArea">
            <div class="inv-qr-box" id="invBoxNam">
                <div id="invTitleNam" style="font-size: 0.7rem; font-weight: 700;">NAM QU√âT ƒê√ÇY</div>
                <img id="invQrNam" class="qr-nam-style" src="" crossorigin="anonymous"> 
            </div>
            <div class="inv-qr-box" id="invBoxNu">
                <div id="invTitleNu" style="font-size: 0.7rem; font-weight: 700;">N·ªÆ QU√âT ƒê√ÇY</div>
                <img id="invQrNu" class="qr-nu-style" src="" crossorigin="anonymous">
            </div>
        </div>

        <div class="inv-footer">
            "Vui l√≤ng thanh to√°n ƒë·ªß.<br>Thi·∫øu 1 xu, ngh·ªâ ƒë√°nh tu·∫ßn sau!"
        </div>
    </div>
</div>

<script>
    // Load th√¥ng tin c≈©
    window.onload = function() {
        if(localStorage.getItem('bankId')) document.getElementById('bankId').value = localStorage.getItem('bankId');
        if(localStorage.getItem('accountNo')) document.getElementById('accountNo').value = localStorage.getItem('accountNo');
        if(localStorage.getItem('accountName')) document.getElementById('accountName').value = localStorage.getItem('accountName');
    }

    let currentMode = 'auto';
    let uploadedQRData = '';

    function switchTab(mode) {
        currentMode = mode;
        document.getElementById('modeAuto').style.display = mode === 'auto' ? 'block' : 'none';
        document.getElementById('modeManual').style.display = mode === 'manual' ? 'block' : 'none';
        document.getElementById('tabAuto').className = mode === 'auto' ? 'switch-btn active' : 'switch-btn';
        document.getElementById('tabManual').className = mode === 'manual' ? 'switch-btn active' : 'switch-btn';
    }

    function saveBankInfo() {
        localStorage.setItem('bankId', document.getElementById('bankId').value);
        localStorage.setItem('accountNo', document.getElementById('accountNo').value);
        localStorage.setItem('accountName', document.getElementById('accountName').value);
    }

    function previewUploadedQR(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedQRData = e.target.result;
                document.getElementById('uploadText').innerText = "ƒê√£ ch·ªçn: " + file.name;
                document.getElementById('uploadText').style.display = 'none';
                document.getElementById('uploadSuccess').style.display = 'inline';
            }
            reader.readAsDataURL(file);
        }
    }

    function formatMoney(amount) {
        return amount.toLocaleString('vi-VN') + ' ƒë';
    }

    function tinhTien() {
        let san = Number(document.getElementById('tienSan').value) || 0;
        let nuoc = Number(document.getElementById('tienNuoc').value) || 0;
        let khac = Number(document.getElementById('chiPhiKhac').value) || 0;
        let cau = Number(document.getElementById('tienCau').value) || 0;
        let nam = Number(document.getElementById('soNam').value) || 0;
        let nu = Number(document.getElementById('soNu').value) || 0;
        let tongNguoi = nam + nu;

        if (tongNguoi === 0) { alert("Alo? Kh√¥ng ai ƒëi ƒë√°nh √†?"); return; }

        let phiChung = (san + nuoc + khac) / tongNguoi;
        let tienCauNam = 0, tienCauNu = 0;

        if (cau > 0) {
            let tongSuat = (nam * 2) + (nu * 1);
            if (tongSuat > 0) {
                let gia1Suat = cau / tongSuat;
                tienCauNu = gia1Suat;
                tienCauNam = gia1Suat * 2;
            }
        }

        let giaNam = Math.ceil(phiChung + tienCauNam);
        let giaNu = Math.ceil(phiChung + tienCauNu);
        let tongTien = san + nuoc + khac + cau;

        document.getElementById('hienThiTong').innerText = formatMoney(tongTien);
        document.getElementById('giaNam').innerText = formatMoney(giaNam);
        document.getElementById('giaNu').innerText = formatMoney(giaNu);

        // --- H√ìA ƒê∆†N LOGIC ---
        let today = new Date();
        document.getElementById('invDate').innerText = today.toLocaleDateString('vi-VN') + " " + today.toLocaleTimeString('vi-VN');
        document.getElementById('invCommon').innerText = formatMoney(san + nuoc + khac);
        document.getElementById('invCau').innerText = formatMoney(cau);
        document.getElementById('invMember').innerText = `${nam} Nam / ${nu} N·ªØ`;
        document.getElementById('invTotal').innerText = formatMoney(tongTien);
        document.getElementById('invPriceNam').innerText = formatMoney(giaNam);
        document.getElementById('invPriceNu').innerText = formatMoney(giaNu);

        // QR LOGIC
        let bankId = document.getElementById('bankId').value;
        let accountNo = document.getElementById('accountNo').value;
        let accountName = document.getElementById('accountName').value;
        
        let screenQrArea = document.getElementById('screenQrArea');
        let invQrArea = document.getElementById('invQrArea');
        
        document.getElementById('invBoxNu').style.display = 'block';
        document.getElementById('invBoxNam').style.width = '48%';
        document.getElementById('invTitleNam').innerText = 'NAM QU√âT ƒê√ÇY';
        document.getElementById('boxScreenQrNu').style.display = 'block';
        document.getElementById('boxScreenQrNam').style.width = '45%';

        if (currentMode === 'auto' && bankId && accountNo) {
            let baseUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact2.jpg`;
            let contentNam = encodeURIComponent("NAM DONG TIEN CAU");
            let contentNu = encodeURIComponent("NU DONG TIEN CAU");
            
            let urlNam = `${baseUrl}?amount=${giaNam}&addInfo=${contentNam}&accountName=${encodeURIComponent(accountName)}`;
            let urlNu = `${baseUrl}?amount=${giaNu}&addInfo=${contentNu}&accountName=${encodeURIComponent(accountName)}`;
            
            document.getElementById('screenQrNam').src = urlNam;
            document.getElementById('screenQrNu').src = urlNu;
            
            document.getElementById('invQrNam').src = urlNam;
            document.getElementById('invQrNu').src = urlNu;
            
            // ƒê·∫£m b·∫£o style m√†u
            document.getElementById('invQrNam').className = 'qr-nam-style';
            document.getElementById('invQrNu').className = 'qr-nu-style';
            
            screenQrArea.style.display = 'block';
            invQrArea.style.display = 'flex';
            invQrArea.style.justifyContent = 'space-between';

        } else if (currentMode === 'manual' && uploadedQRData) {
            document.getElementById('screenQrNam').src = uploadedQRData;
            document.getElementById('boxScreenQrNu').style.display = 'none';
            document.getElementById('boxScreenQrNam').style.width = '60%'; 
            
            screenQrArea.style.display = 'block';

            document.getElementById('invQrNam').src = uploadedQRData;
            document.getElementById('invQrNam').className = ''; // X√≥a style m√†u
            document.getElementById('invQrNam').style.width = '100%'; 
            document.getElementById('invQrNam').style.border = '1px solid #333';

            document.getElementById('invBoxNu').style.display = 'none';
            
            let boxNam = document.getElementById('invBoxNam');
            boxNam.style.width = '100%';
            document.getElementById('invTitleNam').innerText = 'QU√âT M√É CHUY·ªÇN KHO·∫¢N';
            document.getElementById('invQrNam').style.width = '50%';
            document.getElementById('invQrNam').style.margin = '0 auto';

            invQrArea.style.display = 'flex';
            invQrArea.style.justifyContent = 'center';
        } else {
            screenQrArea.style.display = 'none';
            invQrArea.style.display = 'none';
        }

        document.getElementById('khuVucKetQua').style.display = 'block';
        document.getElementById('btnCamera').style.display = 'block';
        document.getElementById('khuVucKetQua').scrollIntoView({ behavior: 'smooth' });
    }

    // --- CH·ª§P H√ìA ƒê∆†N FIXED L·ªÜCH ---
    function chupHoaDon() {
        let modal = document.getElementById('photoModal');
        let loading = document.getElementById('loadingText');
        let img = document.getElementById('capturedImage');
        let content = document.getElementById('modalContent');
        
        modal.style.display = 'flex';
        loading.style.display = 'block';
        content.style.display = 'none';

        // L·∫•y h√≥a ƒë∆°n ƒëang ·∫©n ·ªü v·ªã tr√≠ c·ªë ƒë·ªãnh
        let invoiceNode = document.getElementById('invoice-node');

        // √âp html2canvas ch·ª•p ƒë√∫ng v·ªã tr√≠ top-left 0,0
        setTimeout(() => {
            html2canvas(invoiceNode, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff',
                x: 0, 
                y: 0,
                scrollX: 0,
                scrollY: 0
            }).then(canvas => {
                img.src = canvas.toDataURL("image/png");
                loading.style.display = 'none';
                content.style.display = 'block';
            }).catch(err => {
                alert("L·ªói ch·ª•p: " + err);
                closeModal();
            });
        }, 500); 
    }

    function closeModal() { document.getElementById('photoModal').style.display = 'none'; }
</script>

</body>
</html>