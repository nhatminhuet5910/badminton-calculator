<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLB ƒê·ªët Ti·ªÅn C·∫ßu</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* CSS C∆° b·∫£n */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; color: #333; padding: 15px; box-sizing: border-box;
        }
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(20, 0, 50, 0.8), rgba(0, 0, 0, 0.6)); z-index: 0;
        }
        .container {
            position: relative; z-index: 1; background: rgba(255, 255, 255, 0.96);
            padding: 25px; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            width: 100%; max-width: 450px; backdrop-filter: blur(8px); border: 2px solid rgba(255, 255, 255, 0.4);
        }
        h2 {
            text-align: center; margin-top: 0; font-weight: 800;
            background: -webkit-linear-gradient(#e17055, #d63031);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-size: 1.6rem; margin-bottom: 5px; text-transform: uppercase;
        }
        .subtitle { text-align: center; font-size: 0.85rem; color: #636e72; margin-bottom: 20px; font-style: italic; }
        .section-title {
            font-size: 0.75rem; color: #b2bec3; background: #2d3436; padding: 4px 8px; border-radius: 4px;
            display: inline-block; margin-top: 12px; margin-bottom: 8px; font-weight: 700; text-transform: uppercase;
        }
        .input-row { display: flex; gap: 12px; margin-bottom: 12px; }
        .input-group { flex: 1; }
        label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; color: #2d3436; }
        input, select {
            width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 10px; box-sizing: border-box; font-size: 16px;
            transition: 0.3s; background: #fdfdfd; font-weight: 500; appearance: none;
        }
        input:focus, select:focus { outline: none; border-color: #00cec9; background: #fff; box-shadow: 0 4px 10px rgba(0, 206, 201, 0.15); }
        #tienCau { border-color: #ff7675; color: #d63031; font-weight: 700; }
        
        /* Buttons */
        .button-area { display: flex; gap: 10px; margin-top: 20px; }
        button {
            padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer;
            transition: all 0.2s; text-transform: uppercase; flex: 1;
        }
        .btn-calc { background: linear-gradient(135deg, #0984e3, #6c5ce7); color: white; box-shadow: 0 6px 15px rgba(9, 132, 227, 0.3); }
        .btn-camera { background: linear-gradient(135deg, #00b894, #00cec9); color: white; display: none; flex: 0.8; }
        button:active { transform: translateY(2px); }
        
        /* Result */
        .result {
            margin-top: 20px; padding: 20px; background: #fff; border-radius: 15px; border: 2px dashed #6c5ce7; display: none;
        }
        .result-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1rem; color: #2d3436; align-items: center; }
        .divider { height: 1px; background: #dfe6e9; margin: 12px 0; }
        .final-price { font-size: 1.3rem; font-weight: 800; }
        .male-price { color: #0984e3; } .female-price { color: #e84393; }
        .note { font-size: 0.7rem; text-align: center; color: #b2bec3; margin-top: 8px; font-style: italic; }
        
        /* Bank Config & New Tabs */
        .bank-config { background: #f0fdf4; padding: 15px; border-radius: 12px; border: 1px solid #bbf7d0; margin-bottom: 15px; }
        
        /* SWITCH TOGGLE ƒê·∫∏P */
        .switch-toggle {
            display: flex; background: #e0e7ff; border-radius: 30px; padding: 4px; margin-top: 10px; margin-bottom: 15px; position: relative;
        }
        .switch-btn {
            flex: 1; text-align: center; padding: 10px; border-radius: 25px; cursor: pointer; font-weight: 700; font-size: 0.85rem;
            transition: 0.3s; color: #636e72; z-index: 1; display: flex; align-items: center; justify-content: center; gap: 5px;
        }
        .switch-btn.active {
            background: white; color: #16a34a; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* CUSTOM FILE UPLOAD */
        .file-upload-wrapper {
            position: relative; width: 100%; height: 100px;
            border: 2px dashed #b2bec3; border-radius: 12px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: white; cursor: pointer; transition: 0.3s;
            color: #636e72;
        }
        .file-upload-wrapper:hover {
            border-color: #16a34a; background: #f0fdf4; color: #16a34a;
        }
        .file-upload-wrapper i { font-size: 2rem; margin-bottom: 5px; }
        .file-upload-wrapper input[type="file"] {
            position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }
        .upload-success-text { color: #16a34a; font-weight: bold; display: none; }

        /* QR Section */
        .qr-section { display: none; margin-top: 15px; text-align: center; }
        .qr-container { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .qr-box { flex: 1; text-align: center; background: #f1f2f6; padding: 10px; border-radius: 10px; }
        .qr-box img { width: 100%; border-radius: 5px; mix-blend-mode: multiply; }
        .qr-title { font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; display: block; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-content { background: transparent; padding: 10px; width: 90%; max-width: 400px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .modal-content img { max-width: 100%; max-height: 70vh; border-radius: 10px; border: 2px solid white; display: none; }
        .modal-btn-close { margin-top: 20px; padding: 12px 30px; background: #ff7675; color: white; border: none; border-radius: 25px; font-weight: bold; cursor: pointer; }
        .loading-text { color: white; font-weight: bold; margin-bottom: 15px; font-size: 1.1rem; }

        @media (max-width: 480px) {
            .container { padding: 20px; } .input-row { flex-direction: column; gap: 10px; }
            .button-area { flex-direction: column; } .btn-camera { order: -1; margin-bottom: 10px; }
            .qr-container { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="overlay"></div>

<div class="modal-overlay" id="photoModal">
    <div class="loading-text" id="loadingText">üì∏ ƒêang ch·ªët s·ªï... ƒë·ª£i x√≠u!</div>
    <div class="modal-content" id="modalContent">
        <div id="tutorialText" style="color: #dfe6e9; margin-bottom: 10px; font-size: 0.9rem; display: none;">üëá Nh·∫•n gi·ªØ ·∫£nh ƒë·ªÉ <b>L∆∞u l√†m b·∫±ng ch·ª©ng</b></div>
        <img id="capturedImage" src="">
        <button class="modal-btn-close" onclick="closeModal()">ƒê√≥ng l·∫°i</button>
    </div>
</div>

<div class="container" id="captureArea">
    <h2>üí∏ CLB ƒê·ªêT TI·ªÄN C·∫¶U</h2>
    <div class="subtitle">S√¢n kinh t·∫ø, t√≠nh ti·ªÅn ƒë·ª´ng th·∫Øc m·∫Øc</div>
    
    <div class="bank-config">
        <div class="section-title" style="margin-top:0; color: #166534; background: none; padding: 0;">
            <i class="fas fa-university"></i> KHO TH√ìC NH·∫¨N TI·ªÄN
        </div>
        
        <div class="switch-toggle">
            <div class="switch-btn active" id="tabAuto" onclick="switchTab('auto')">
                <i class="fas fa-robot"></i> Auto T·∫≠n RƒÉng
            </div>
            <div class="switch-btn" id="tabManual" onclick="switchTab('manual')">
                <i class="fas fa-image"></i> ·∫¢nh QR (H√†ng Th·ª≠a)
            </div>
        </div>

        <div id="modeAuto">
            <div class="input-row">
                <div class="input-group">
                    <label>Ng√¢n h√†ng (Kho B·∫°c)</label>
                    <select id="bankId" onchange="saveBankInfo()">
                        <option value="">Ch·ªçn Kho...</option>
                        <option value="970436">Vietcombank</option>
                        <option value="970415">VietinBank</option>
                        <option value="970405">Agribank</option>
                        <option value="970418">BIDV</option>
                        <option value="970407">Techcombank</option>
                        <option value="970422">MB Bank</option>
                        <option value="970416">ACB</option>
                        <option value="970432">VPBank</option>
                        <option value="970423">TPBank</option>
                        <option value="970403">Sacombank</option>
                        <option value="970441">VIB</option>
                        <option value="970454">VietCapital</option>
                        <option value="963388">Timo</option>
                        <option value="971005">ViettelMoney</option>
                        <option value="971011">Momo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>S·ªë k√©t s·∫Øt (STK)</label>
                    <input type="text" id="accountNo" placeholder="Nh·∫≠p STK..." oninput="saveBankInfo()">
                </div>
            </div>
            <div class="input-group">
                <label>Ch·ªß N·ª£ (T√™n kh√¥ng d·∫•u)</label>
                <input type="text" id="accountName" placeholder="V√≠ d·ª•: NGUYEN VAN A" oninput="saveBankInfo()">
            </div>
            <div style="font-size: 0.7rem; color: #166534; margin-top: 5px; font-style: italic;">
                <i class="fas fa-check-circle"></i> Nh·∫≠p 1 l·∫ßn d√πng c·∫£ ƒë·ªùi. T·ª± ƒëi·ªÅn s·ªë ti·ªÅn, qu√©t l√† ting ting!
            </div>
        </div>

        <div id="modeManual" style="display: none;">
            <label style="margin-bottom: 8px;">Upload ·∫£nh QR c·ªßa b·∫°n:</label>
            <div class="file-upload-wrapper">
                <input type="file" id="qrUpload" accept="image/*" onchange="previewUploadedQR(event)">
                <i class="fas fa-cloud-upload-alt"></i>
                <span id="uploadText">B·∫•m v√†o ƒë·ªÉ ch·ªçn ·∫£nh QR</span>
                <span class="upload-success-text" id="uploadSuccess">
                    <i class="fas fa-check"></i> ƒê√£ nh·∫≠n h√†ng!
                </span>
            </div>
            <div style="font-size: 0.7rem; color: #d63031; margin-top: 8px; font-style: italic;">
                *L∆∞u √Ω: D√πng ·∫£nh n√†y th√¨ anh em t·ª± nh·∫≠p s·ªë ti·ªÅn nh√©, web kh√¥ng ƒë·ªô ƒë∆∞·ª£c ƒë√¢u.
            </div>
        </div>
    </div>

    <div class="section-title">üíÄ Chi Ph√≠ M·∫∑t B·∫±ng (Chia ƒê·ªÅu)</div>
    <div class="input-row">
        <div class="input-group">
            <label>C·ªëng n·∫°p ch·ªß s√¢n</label>
            <input type="number" id="tienSan" placeholder="200000">
        </div>
        <div class="input-group">
            <label>N∆∞·ªõc th√°nh</label>
            <input type="number" id="tienNuoc" placeholder="30000">
        </div>
    </div>
    <div class="input-group">
        <label>ƒÇn ch∆°i nh·∫£y m√∫a kh√°c</label>
        <input type="number" id="chiPhiKhac" placeholder="G·ª≠i xe, tr√† ƒë√°...">
    </div>

    <div class="section-title" style="background: #d63031; color: white;">üî• Thi·ªát H·∫°i L√¥ng L√°</div>
    <div class="input-group">
        <label>Ti·ªÅn C·∫ßu (Nam ph√°, N·ªØ ch·ªãu)</label>
        <input type="number" id="tienCau" placeholder="Nh·∫≠p s·ªë ti·ªÅn c·∫ßu..." >
        <div style="font-size: 0.7rem; color: #636e72; font-style: italic; margin-top: 5px;">*Logic: Nam ƒë√≥ng g·∫•p ƒë√¥i N·ªØ (Cho ch·ª´a c√°i t·ªôi ƒë·∫≠p c·∫ßu).</div>
    </div>

    <div class="section-title">üëΩ ƒêi·ªÉm Danh</div>
    <div class="input-row">
        <div class="input-group">
            <label>Nam th·∫ßn (‚ôÇ)</label>
            <input type="number" id="soNam" placeholder="0">
        </div>
        <div class="input-group">
            <label>N·ªØ th·∫ßn (‚ôÄ)</label>
            <input type="number" id="soNu" placeholder="0">
        </div>
    </div>

    <div class="button-area">
        <button class="btn-calc" onclick="tinhTien()">‚ö° T√≠nh Ti·ªÅn & Hi·ªán QR</button>
        <button class="btn-camera" id="btnCamera" onclick="chupAnhManHinh()">üì∏ S·ªë Ti·ªÅn ƒê√≥ng H·ªç</button>
    </div>

    <div class="result" id="khuVucKetQua">
        <div class="result-item">
            <span>T·ªïng thi·ªát h·∫°i:</span>
            <span id="hienThiTong" style="font-weight: bold; color: #d63031;">0 ƒë</span>
        </div>
        <div class="divider"></div>
        
        <div class="result-item">
            <span>üë¶ Anh em m√≥c v√≠:</span>
            <span class="final-price male-price" id="giaNam">0 ƒë</span>
        </div>
        <div class="result-item">
            <span>üëß Ch·ªã em ƒë√≥ng nh·∫π:</span>
            <span class="final-price female-price" id="giaNu">0 ƒë</span>
        </div>

        <div class="qr-section" id="qrSection">
            <div class="divider"></div>
            <div style="font-weight: bold; color: #166534; margin-bottom: 10px;">üì≤ QU√âT NHANH KH√îNG L√ÉI M·∫∏ ƒê·∫∫ L√ÉI CON</div>
            
            <div class="qr-container" id="qrAutoContainer">
                <div class="qr-box">
                    <span class="qr-title male-price">QR CHO NAM TH·∫¶N</span>
                    <img id="qrNam" src="" alt="QR Nam">
                </div>
                <div class="qr-box">
                    <span class="qr-title female-price">QR CHO N·ªÆ TH·∫¶N</span>
                    <img id="qrNu" src="" alt="QR Nu">
                </div>
            </div>

            <div class="qr-container" id="qrManualContainer" style="display: none;">
                <div class="qr-box">
                    <span class="qr-title" style="color: #333;">QR C·ª¶A CH·ª¶ N·ª¢</span>
                    <img id="qrUploadedShow" src="" alt="QR Uploaded">
                    <div style="font-size: 0.7rem; color: #d63031; margin-top: 5px;">(T·ª± nh·∫≠p s·ªë ti·ªÅn nh√© c√°c ƒë·ªìng ch√≠)</div>
                </div>
            </div>

        </div>

        <div class="note">*S·ªë li·ªáu chu·∫©n t·ª´ng xu (kh√¥ng l√†m tr√≤n)</div>
    </div>
</div>

<script>
    // --- KH·ªûI T·∫†O: Load th√¥ng tin ƒë√£ l∆∞u ---
    window.onload = function() {
        if(localStorage.getItem('bankId')) document.getElementById('bankId').value = localStorage.getItem('bankId');
        if(localStorage.getItem('accountNo')) document.getElementById('accountNo').value = localStorage.getItem('accountNo');
        if(localStorage.getItem('accountName')) document.getElementById('accountName').value = localStorage.getItem('accountName');
    }

    let currentMode = 'auto';
    let uploadedQRData = '';

    function switchTab(mode) {
        currentMode = mode;
        if (mode === 'auto') {
            document.getElementById('modeAuto').style.display = 'block';
            document.getElementById('modeManual').style.display = 'none';
            document.getElementById('tabAuto').classList.add('active');
            document.getElementById('tabManual').classList.remove('active');
        } else {
            document.getElementById('modeAuto').style.display = 'none';
            document.getElementById('modeManual').style.display = 'block';
            document.getElementById('tabAuto').classList.remove('active');
            document.getElementById('tabManual').classList.add('active');
        }
    }

    function saveBankInfo() {
        localStorage.setItem('bankId', document.getElementById('bankId').value);
        localStorage.setItem('accountNo', document.getElementById('accountNo').value);
        localStorage.setItem('accountName', document.getElementById('accountName').value);
    }

    function previewUploadedQR(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedQRData = e.target.result;
                // Hi·ªáu ·ª©ng ƒë√£ ch·ªçn
                document.getElementById('uploadText').style.display = 'none';
                document.getElementById('uploadSuccess').style.display = 'inline';
            }
            reader.readAsDataURL(file);
        }
    }

    function formatMoney(amount) {
        return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function tinhTien() {
        // L·∫•y d·ªØ li·ªáu
        let san = Number(document.getElementById('tienSan').value) || 0;
        let nuoc = Number(document.getElementById('tienNuoc').value) || 0;
        let khac = Number(document.getElementById('chiPhiKhac').value) || 0;
        let cau = Number(document.getElementById('tienCau').value) || 0;
        
        let nam = Number(document.getElementById('soNam').value) || 0;
        let nu = Number(document.getElementById('soNu').value) || 0;
        let tongNguoi = nam + nu;

        if (tongNguoi === 0) { alert("Vui l√≤ng nh·∫≠p s·ªë ng∆∞·ªùi!"); return; }

        let phiChung = (san + nuoc + khac) / tongNguoi;
        let tienCauNam = 0, tienCauNu = 0;

        if (cau > 0) {
            let tongSuat = (nam * 2) + (nu * 1);
            if (tongSuat > 0) {
                let gia1Suat = cau / tongSuat;
                tienCauNu = gia1Suat;
                tienCauNam = gia1Suat * 2;
            }
        }

        let giaNam = Math.ceil(phiChung + tienCauNam);
        let giaNu = Math.ceil(phiChung + tienCauNu);
        let tongTien = san + nuoc + khac + cau;

        document.getElementById('hienThiTong').innerText = formatMoney(tongTien);
        document.getElementById('giaNam').innerText = formatMoney(giaNam);
        document.getElementById('giaNu').innerText = formatMoney(giaNu);

        // --- X·ª¨ L√ù HI·ªÇN TH·ªä QR ---
        let qrSection = document.getElementById('qrSection');
        let qrAutoContainer = document.getElementById('qrAutoContainer');
        let qrManualContainer = document.getElementById('qrManualContainer');

        if (currentMode === 'auto') {
            let bankId = document.getElementById('bankId').value;
            let accountNo = document.getElementById('accountNo').value;
            let accountName = document.getElementById('accountName').value.trim();

            if (bankId && accountNo) {
                let contentNam = encodeURIComponent("NAM DONG TIEN CAU");
                let contentNu = encodeURIComponent("NU DONG TIEN CAU");
                let baseUrl = `https://img.vietqr.io/image/${bankId}-${accountNo}-compact2.jpg`;
                
                document.getElementById('qrNam').src = `${baseUrl}?amount=${giaNam}&addInfo=${contentNam}&accountName=${encodeURIComponent(accountName)}`;
                document.getElementById('qrNu').src = `${baseUrl}?amount=${giaNu}&addInfo=${contentNu}&accountName=${encodeURIComponent(accountName)}`;
                
                qrAutoContainer.style.display = 'flex';
                qrManualContainer.style.display = 'none';
                qrSection.style.display = 'block';
            } else {
                qrSection.style.display = 'none';
            }
        } else {
            // Ch·∫ø ƒë·ªô Upload ·∫¢nh
            if (uploadedQRData) {
                document.getElementById('qrUploadedShow').src = uploadedQRData;
                qrAutoContainer.style.display = 'none';
                qrManualContainer.style.display = 'flex';
                qrSection.style.display = 'block';
            } else {
                alert("Ch∆∞a ch·ªçn ·∫£nh QR k√¨a s·∫øp ∆°i!");
                qrSection.style.display = 'none';
            }
        }

        let ketQua = document.getElementById('khuVucKetQua');
        ketQua.style.display = 'block';
        document.getElementById('btnCamera').style.display = 'block';
        ketQua.scrollIntoView({ behavior: 'smooth' });
    }

    // Logic Ch·ª•p ·∫¢nh (Fix l·ªói b·∫£o m·∫≠t)
    function chupAnhManHinh() {
        let modal = document.getElementById('photoModal');
        let loading = document.getElementById('loadingText');
        let img = document.getElementById('capturedImage');
        let tutorial = document.getElementById('tutorialText');
        
        img.style.display = 'none'; tutorial.style.display = 'none';
        loading.style.display = 'block'; modal.style.display = 'flex';
        document.querySelector('.button-area').style.display = 'none';
        
        setTimeout(() => {
            html2canvas(document.getElementById('captureArea'), {
                scale: 2, useCORS: true, backgroundColor: null
            }).then(canvas => {
                document.querySelector('.button-area').style.display = 'flex';
                img.src = canvas.toDataURL("image/png");
                img.onload = function() { loading.style.display = 'none'; img.style.display = 'block'; tutorial.style.display = 'block'; };
            }).catch(err => {
                alert("L·ªói: " + err); closeModal();
                document.querySelector('.button-area').style.display = 'flex';
            });
        }, 500);
    }
    function closeModal() { document.getElementById('photoModal').style.display = 'none'; }
</script>

</body>
</html>